---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getAllTestimonials } from '../lib/sanity';

const testimonials = await getAllTestimonials();

// Calculate statistics
const totalReviews = testimonials.length;
const averageRating = testimonials.reduce((sum: number, t: any) => sum + t.rating, 0) / totalReviews;
const fiveStarCount = testimonials.filter((t: any) => t.rating === 5).length;
const fourStarCount = testimonials.filter((t: any) => t.rating >= 4 && t.rating < 5).length;

const platformCounts = {
  airbnb: testimonials.filter((t: any) => t.platform === 'airbnb').length,
  vrbo: testimonials.filter((t: any) => t.platform === 'vrbo').length,
  direct: testimonials.filter((t: any) => t.platform === 'direct').length,
  google: testimonials.filter((t: any) => t.platform === 'google').length,
};

// Format date helper
function formatDate(dateString: string) {
  if (!dateString) return 'Recent Guest';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
}

// Platform display names and icons
const platformInfo: any = {
  airbnb: { name: 'Airbnb', icon: 'üè†', color: '#FF5A5F' },
  vrbo: { name: 'VRBO', icon: 'üèòÔ∏è', color: '#003B95' },
  direct: { name: 'Direct Booking', icon: '‚úâÔ∏è', color: '#28a745' },
  google: { name: 'Google', icon: 'üîç', color: '#4285F4' },
};

const metaTitle = 'Guest Reviews | The Rittenhouse Residence';
const metaDescription = `Read ${totalReviews}+ verified guest reviews. ${Math.round(averageRating * 10) / 10}‚≠ê average rating. See why guests love our historic Rittenhouse mansion.`;
---

<BaseLayout title={metaTitle} description={metaDescription}>
  <main class="reviews-page">

    <!-- Hero Section -->
    <section class="reviews-hero">
      <div class="container">
        <h1>What Our Guests Say</h1>
        <p class="hero-subtitle">Real reviews from verified stays</p>

        <!-- Stats Summary -->
        <div class="stats-summary">
          <div class="stat-card">
            <div class="stat-number">{Math.round(averageRating * 10) / 10}</div>
            <div class="stat-stars">{'‚≠ê'.repeat(Math.floor(averageRating))}</div>
            <div class="stat-label">Average Rating</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{totalReviews}+</div>
            <div class="stat-label">Verified Reviews</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{Math.round((fiveStarCount / totalReviews) * 100)}%</div>
            <div class="stat-label">5-Star Reviews</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">500+</div>
            <div class="stat-label">Happy Guests</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Filter Bar -->
    <section class="reviews-filters">
      <div class="container">
        <div class="filter-group">
          <label>Filter by Rating:</label>
          <div class="filter-buttons">
            <button class="filter-btn active" data-filter-type="rating" data-filter="all">
              All Reviews
            </button>
            <button class="filter-btn" data-filter-type="rating" data-filter="5">
              ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê ({fiveStarCount})
            </button>
            <button class="filter-btn" data-filter-type="rating" data-filter="4">
              ‚≠ê‚≠ê‚≠ê‚≠ê ({fourStarCount})
            </button>
          </div>
        </div>

        <div class="filter-group">
          <label>Filter by Platform:</label>
          <div class="filter-buttons">
            <button class="filter-btn active" data-filter-type="platform" data-filter="all">
              All Platforms
            </button>
            {Object.entries(platformCounts).map(([platform, count]) => {
              if (count > 0) {
                const info = platformInfo[platform];
                return (
                  <button class="filter-btn" data-filter-type="platform" data-filter={platform}>
                    <span>{info.icon}</span>
                    {info.name} ({count})
                  </button>
                );
              }
            })}
          </div>
        </div>

        <div class="sort-group">
          <label for="sort-select">Sort by:</label>
          <select id="sort-select">
            <option value="recent">Most Recent</option>
            <option value="highest">Highest Rated</option>
            <option value="lowest">Lowest Rated</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Reviews Grid -->
    <section class="reviews-grid-section">
      <div class="container">
        <div class="reviews-grid" id="reviews-grid">
          {testimonials.map((review: any, index: number) => {
            const platform = platformInfo[review.platform] || platformInfo.direct;

            return (
              <div
                class="review-card"
                data-rating={review.rating}
                data-platform={review.platform}
                data-date={review.stayDate}
                data-index={index}
              >
                <div class="review-header">
                  <div class="reviewer-info">
                    <div class="reviewer-avatar">
                      {review.guestName.charAt(0).toUpperCase()}
                    </div>
                    <div>
                      <h3 class="reviewer-name">{review.guestName}</h3>
                      <p class="stay-date">{formatDate(review.stayDate)}</p>
                    </div>
                  </div>

                  <div class="review-meta">
                    <div class="rating-stars">
                      {'‚≠ê'.repeat(Math.floor(review.rating))}
                    </div>
                    <div
                      class="platform-badge"
                      style={`background-color: ${platform.color}`}
                    >
                      <span>{platform.icon}</span>
                      <span>{platform.name}</span>
                    </div>
                  </div>
                </div>

                <div class="review-body">
                  <p class="review-text">{review.review}</p>
                </div>

                {review.verified && (
                  <div class="verified-badge">
                    <span class="verified-icon">‚úì</span>
                    Verified Stay
                  </div>
                )}
              </div>
            );
          })}
        </div>

        <div class="no-results" id="no-results" style="display: none;">
          <p>No reviews match your filters. Try adjusting your selection.</p>
          <button class="btn btn-secondary" onclick="resetFilters()">Reset Filters</button>
        </div>
      </div>
    </section>

    <!-- Trust Indicators -->
    <section class="trust-section">
      <div class="container">
        <h2>Why Guests Choose Us</h2>

        <div class="trust-grid">
          <div class="trust-card">
            <div class="trust-icon">üèÜ</div>
            <h3>Airbnb Superhost</h3>
            <p>Consistently rated 5 stars with exceptional hospitality</p>
          </div>

          <div class="trust-card">
            <div class="trust-icon">‚úì</div>
            <h3>100% Verified</h3>
            <p>All reviews from confirmed bookings</p>
          </div>

          <div class="trust-card">
            <div class="trust-icon">üí¨</div>
            <h3>500+ Reviews</h3>
            <p>Across Airbnb, VRBO, and direct bookings</p>
          </div>

          <div class="trust-card">
            <div class="trust-icon">‚≠ê</div>
            <h3>{Math.round(averageRating * 10) / 10} Average</h3>
            <p>Outstanding ratings across all platforms</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Booking CTA -->
    <section class="reviews-cta">
      <div class="container">
        <div class="cta-content">
          <h2>Join Our Happy Guests</h2>
          <p>Book your unforgettable stay in our historic Rittenhouse mansion</p>
          <div class="cta-buttons">
            <a href="/rates" class="btn btn-primary btn-large">View Rates & Book</a>
            <a href="/contact" class="btn btn-secondary btn-large">Have Questions?</a>
          </div>
        </div>
      </div>
    </section>

  </main>
</BaseLayout>

<script define:vars={{ testimonials }}>
  const reviewCards = document.querySelectorAll('.review-card');
  const filterButtons = document.querySelectorAll('.filter-btn');
  const sortSelect = document.getElementById('sort-select');
  const noResults = document.getElementById('no-results');
  const reviewsGrid = document.getElementById('reviews-grid');

  let activeFilters = {
    rating: 'all',
    platform: 'all'
  };

  // Filter functionality
  filterButtons.forEach(button => {
    button.addEventListener('click', () => {
      const filterType = button.getAttribute('data-filter-type');
      const filterValue = button.getAttribute('data-filter');

      // Update active state for this filter group
      const groupButtons = document.querySelectorAll(`[data-filter-type="${filterType}"]`);
      groupButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');

      // Update active filters
      activeFilters[filterType] = filterValue;

      applyFilters();
    });
  });

  // Sort functionality
  sortSelect.addEventListener('change', () => {
    sortReviews(sortSelect.value);
  });

  function applyFilters() {
    let visibleCount = 0;

    reviewCards.forEach(card => {
      const rating = parseFloat(card.getAttribute('data-rating'));
      const platform = card.getAttribute('data-platform');

      let matchesRating = activeFilters.rating === 'all' ||
        (activeFilters.rating === '5' && rating === 5) ||
        (activeFilters.rating === '4' && rating >= 4 && rating < 5);

      let matchesPlatform = activeFilters.platform === 'all' ||
        platform === activeFilters.platform;

      if (matchesRating && matchesPlatform) {
        card.style.display = 'block';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });

    // Show "no results" if needed
    reviewsGrid.style.display = visibleCount === 0 ? 'none' : 'grid';
    noResults.style.display = visibleCount === 0 ? 'block' : 'none';
  }

  function sortReviews(sortType) {
    const cardsArray = Array.from(reviewCards);

    cardsArray.sort((a, b) => {
      if (sortType === 'recent') {
        const dateA = new Date(a.getAttribute('data-date') || '2000-01-01');
        const dateB = new Date(b.getAttribute('data-date') || '2000-01-01');
        return dateB - dateA;
      } else if (sortType === 'highest') {
        const ratingA = parseFloat(a.getAttribute('data-rating'));
        const ratingB = parseFloat(b.getAttribute('data-rating'));
        return ratingB - ratingA;
      } else if (sortType === 'lowest') {
        const ratingA = parseFloat(a.getAttribute('data-rating'));
        const ratingB = parseFloat(b.getAttribute('data-rating'));
        return ratingA - ratingB;
      }
      return 0;
    });

    // Re-append in sorted order
    cardsArray.forEach(card => reviewsGrid.appendChild(card));
  }

  function resetFilters() {
    activeFilters = { rating: 'all', platform: 'all' };
    filterButtons.forEach(btn => {
      const filterValue = btn.getAttribute('data-filter');
      if (filterValue === 'all') {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
    sortSelect.value = 'recent';
    applyFilters();
    sortReviews('recent');
  }

  // Make resetFilters global for the button onclick
  window.resetFilters = resetFilters;

  // Initial sort
  sortReviews('recent');

  // Scroll animations
  const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('fade-in');
      }
    });
  }, observerOptions);

  reviewCards.forEach(card => observer.observe(card));
</script>

<style>
  /* Hero */
  .reviews-hero {
    background: linear-gradient(135deg, var(--navy-primary) 0%, #2a3f5f 100%);
    color: white;
    padding: 4rem 0;
    text-align: center;
  }

  .reviews-hero h1 {
    font-family: var(--font-serif);
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  .hero-subtitle {
    font-size: 1.25rem;
    margin-bottom: 3rem;
    opacity: 0.9;
  }

  /* Stats Summary */
  .stats-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 2rem;
    max-width: 900px;
    margin: 0 auto;
  }

  .stat-card {
    background: rgba(255, 255, 255, 0.1);
    padding: 2rem;
    border-radius: 12px;
    backdrop-filter: blur(10px);
  }

  .stat-number {
    font-size: 3rem;
    font-weight: 700;
    font-family: var(--font-serif);
    margin-bottom: 0.5rem;
  }

  .stat-stars {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .stat-label {
    font-size: 1rem;
    opacity: 0.9;
  }

  /* Filters */
  .reviews-filters {
    padding: 2rem 0;
    background: #f8f9fa;
    border-bottom: 2px solid #e0e0e0;
  }

  .filter-group,
  .sort-group {
    margin-bottom: 1.5rem;
  }

  .filter-group:last-child,
  .sort-group:last-child {
    margin-bottom: 0;
  }

  .filter-group label,
  .sort-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: var(--navy-primary);
  }

  .filter-buttons {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .filter-btn {
    padding: 0.75rem 1.25rem;
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.95rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .filter-btn:hover {
    border-color: var(--gold-accent);
    transform: translateY(-2px);
  }

  .filter-btn.active {
    background: var(--navy-primary);
    color: white;
    border-color: var(--navy-primary);
  }

  #sort-select {
    padding: 0.75rem 1.25rem;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    background: white;
  }

  /* Reviews Grid */
  .reviews-grid-section {
    padding: 3rem 0;
    background: white;
  }

  .reviews-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 2rem;
  }

  @media (max-width: 768px) {
    .reviews-grid {
      grid-template-columns: 1fr;
    }
  }

  .review-card {
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s;
    opacity: 0;
  }

  .review-card.fade-in {
    opacity: 1;
  }

  .review-card:hover {
    border-color: var(--gold-accent);
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    transform: translateY(-4px);
  }

  .review-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e0e0e0;
  }

  .reviewer-info {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .reviewer-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--gold-accent);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 700;
  }

  .reviewer-name {
    font-weight: 600;
    color: var(--navy-primary);
    margin-bottom: 0.25rem;
  }

  .stay-date {
    font-size: 0.875rem;
    color: #666;
  }

  .review-meta {
    text-align: right;
  }

  .rating-stars {
    font-size: 1.25rem;
    margin-bottom: 0.5rem;
  }

  .platform-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    color: white;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .review-body {
    margin-bottom: 1rem;
  }

  .review-text {
    color: #333;
    line-height: 1.7;
    font-size: 1rem;
  }

  .verified-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: #e8f5e9;
    color: #2e7d32;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
  }

  .verified-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    background: #2e7d32;
    color: white;
    border-radius: 50%;
    font-size: 0.75rem;
  }

  /* No Results */
  .no-results {
    text-align: center;
    padding: 4rem 2rem;
  }

  .no-results p {
    font-size: 1.25rem;
    color: #666;
    margin-bottom: 2rem;
  }

  /* Trust Section */
  .trust-section {
    padding: 4rem 0;
    background: #f8f9fa;
  }

  .trust-section h2 {
    font-family: var(--font-serif);
    font-size: 2.5rem;
    text-align: center;
    margin-bottom: 3rem;
  }

  .trust-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
  }

  .trust-card {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  }

  .trust-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  .trust-card h3 {
    font-family: var(--font-serif);
    color: var(--navy-primary);
    margin-bottom: 0.5rem;
  }

  .trust-card p {
    color: #666;
    line-height: 1.6;
  }

  /* CTA */
  .reviews-cta {
    padding: 6rem 0;
    background: linear-gradient(135deg, var(--navy-primary) 0%, #2a3f5f 100%);
    color: white;
  }

  .cta-content {
    text-align: center;
  }

  .cta-content h2 {
    font-family: var(--font-serif);
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  .cta-content p {
    font-size: 1.25rem;
    margin-bottom: 2rem;
    opacity: 0.9;
  }

  .cta-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
  }

  @media (max-width: 768px) {
    .cta-buttons {
      flex-direction: column;
      max-width: 300px;
      margin: 0 auto;
    }
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 2rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s;
  }

  .btn-large {
    padding: 1.25rem 2.5rem;
    font-size: 1.125rem;
  }

  .btn-primary {
    background: var(--gold-accent);
    color: var(--navy-primary);
  }

  .btn-primary:hover {
    background: #b89850;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(201, 169, 97, 0.4);
  }

  .btn-secondary {
    background: transparent;
    color: white;
    border: 2px solid white;
  }

  .btn-secondary:hover {
    background: white;
    color: var(--navy-primary);
  }
</style>
